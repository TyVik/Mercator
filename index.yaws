<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Mercator Puzzle!</title>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&subset=all" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="main.css">
    <script type="text/javascript" src="//maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=geometry"></script>
    <script src="js/google.maps.Polygon.getBounds.js"></script>
    <script src="js/google.maps.Polygon.moveTo.js"></script>
    <script src="js/country.js"></script>
    <script type="text/javascript">
<erl>
country(Name) ->
  {ok, Cols, [{Rows}]} = sql_driver:run_sql("SELECT \"Polygon\" from \"Countries\" where \"Name\" = \'" ++ Name ++ "\'"),
  geo:polygon(Rows).

echoJSVar({Countries, Answers}) ->
  "var countries = [" ++ Countries ++ "]; \n" ++ "var answers = [" ++ Answers ++ "];".

countries(Count) ->
  {ok, Cols, Rows} = sql_driver:run_sql("SELECT \"Polygon\", \"Answer\" from \"Countries\" where \"Name\" = \'Norway\' order by RANDOM() limit " ++ Count),
  geo:parsePolygonsAndAnswers(Rows).

out(Arg) ->
  case queryvar(Arg, "name") of
    {ok, Name} -> {html, echoJSVar({country(Name), ""})};
    undefined ->
      case queryvar(Arg, "count") of
        {ok, Count} -> {html, echoJSVar(countries(Count))}
      end
  end.
</erl>
    </script>
    <script type="text/javascript" src="main.js"></script>
  </head>

  <body>
    <div id="map"></div>
  </body>

  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-18071-1']);
  _gaq.push(['_trackPageview']);
</script>
</html>
